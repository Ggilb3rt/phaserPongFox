<!DOCTYPE html>
<html>
<head>
    <script src="./dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

<script>

    // import Fox from "./foxClass"

    var game = new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 640,
            // parent: containerId,
            scale: {
                // mode: Phaser.Scale.RESIZE,
                autoCenter: Phaser.Scale.CENTER_BOTH,
            },
            physics: {
            default: "arcade",
            arcade: {
                gravity: false,
                debug: false,
            },
            },
            scene: {
                preload,
                create,
                update,
            },
        });

    let ball;
    let playerOne;
    let playerTwo;
    let isGameStarted = false;
    let cursors;
    let keys = {};
    let playerOneVictoryText;
    let playerTwoVictoryText;
    const paddleSpeed = 350;


    let foxSpeed = 100
    let foxVelocityLeftUP = -foxSpeed
    let foxVelocityRightDown = foxSpeed
    const foxLimitLeft = 230
    const foxLimitRight = 800 - foxLimitLeft

    function preload() {
        this.load.setBaseURL('game/');

        this.load.image("ball", "assets/fox/ball.png");
        this.load.image("paddle", "assets/fox/paddle.png");
        this.load.image("bg", "assets/fox/foxPongBg.jpg");
        this.load.spritesheet("fox_wait", "assets/fox/waiting_fox.png", {
            frameWidth: 161/5, frameHeight: 15
        });
        this.load.spritesheet("fox_run", "assets/fox/walking_fox.png", {
            frameWidth: 256/8, frameHeight: 16
        });
        this.load.spritesheet("fox_jump", "assets/fox/jumping_fox.png", {
            frameWidth: 352/11, frameHeight: 18
        });
        this.load.spritesheet("fox_watch", "assets/fox/waiting_watching_fox.png", {
            frameWidth: 448/14, frameHeight: 15
        });
    }

    function create() {

        this.add.image(400, 320, "bg")

        console.log(foxLimitRight, foxLimitLeft)
        fox = this.physics.add.sprite(
            this.physics.world.bounds.width / 2 - 20,
            this.physics.world.bounds.height / 2 - 30,
            "fox_wait"
        ).setScale(3).refreshBody()

        this.anims.create({
            key: 'idle_fox',
            frames: this.anims.generateFrameNumbers('fox_wait', { start: 0, end: 4 }),
            frameRate: 5,
            repeat: -1
        });
        this.anims.create({
            key: 'run_fox',
            frames: this.anims.generateFrameNumbers('fox_run', { start: 0, end: 4 }),
            frameRate: 8,
            repeat: -1
        });
        this.anims.create({
            key: 'jump_fox',
            frames: this.anims.generateFrameNumbers('fox_jump', { start: 0, end: 4 }),
            frameRate: 11,
            repeat: -1
        });

        fox.anims.play('run_fox')
        fox.setCollideWorldBounds(true);
        fox.setImmovable(true);


        // ORIANE
        ball = this.physics.add.sprite(
            this.physics.world.bounds.width / 2,
            this.physics.world.bounds.height / 2,
            "ball"
        );
        ball.setCollideWorldBounds(true);
        ball.setBounce(1, 1);

        playerOne = this.physics.add.sprite(
            this.physics.world.bounds.width - (ball.body.width / 2 + 1),
            this.physics.world.bounds.height / 2,
            "paddle"
        );
        playerOne.setCollideWorldBounds(true);
        playerOne.setImmovable(true);

        cursors = this.input.keyboard.createCursorKeys();
        keys.w = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
        keys.s = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);

        playerTwo = this.physics.add.sprite(
            ball.body.width / 2 + 1,
            this.physics.world.bounds.height / 2,
            "paddle"
        );
        playerTwo.setCollideWorldBounds(true);
        playerTwo.setImmovable(true);

        this.physics.add.collider(ball, playerOne);
        this.physics.add.collider(ball, playerTwo);

        playerOneVictoryText = this.add.text(
            this.physics.world.bounds.width / 2,
            this.physics.world.bounds.height / 2,
            "Player 1 wins !"
        );
        playerOneVictoryText.setVisible(false);
        playerOneVictoryText.setOrigin(0.5);

        playerTwoVictoryText = this.add.text(
            this.physics.world.bounds.width / 2,
            this.physics.world.bounds.height / 2,
            "Player 2 wins !"
        );
        playerTwoVictoryText.setVisible(false);
        playerTwoVictoryText.setOrigin(0.5);




        this.physics.add.collider(ball, fox);
    }

    function update() {
        // fox
        const bx = ball.body.x
        const by = ball.body.y
        
        const fx = fox.body.x
        const fy = fox.body.y
        
        const distance = Phaser.Math.Distance.Between(fx, fy, bx, by)
        if (distance > 300) {
            if (Math.random() > 0.5) {
                fox.anims.play('jump_fox', true);
                // foxSpeed = foxSpeed * 200 // not works
            }
        }
        else
            fox.anims.play('run_fox', true)
        // Make the fox run on the ball
        const rotation = Phaser.Math.Angle.Between(fx, fy, bx, by)
        fox.setRotation(rotation)
                // remove fx <> foxLimitXY is better
        if (rotation >= 0 && rotation <= Math.PI / 2 && fx < foxLimitRight) {
            fox.setVelocity(foxVelocityRightDown, foxVelocityRightDown)
        }
        else if (rotation > Math.PI / 2 && rotation <= Math.PI && fx > foxLimitLeft )
            fox.setVelocity(foxVelocityLeftUP, foxVelocityRightDown)
        else if (rotation < 0 && rotation >= -Math.PI / 2 && fx < foxLimitRight)
            fox.setVelocity(foxVelocityRightDown, foxVelocityLeftUP)
        else if (rotation < -Math.PI / 2 && rotation > -Math.PI && fx > foxLimitLeft)
            fox.setVelocity(foxVelocityLeftUP, foxVelocityLeftUP)
        else
            fox.setVelocity(0, 0)


        // else if (rotation > )
        // /fox
        

        // ORIANE
        if (!isGameStarted) {
            const initialVelocityX = Math.random() * 150 + 100;
            const initialVelocityY = Math.random() * 150 + 100;
            ball.setVelocityX(initialVelocityX);
            ball.setVelocityY(initialVelocityY);
            isGameStarted = true;
            
            
        }


        // Use to stop the game
        if (ball.body.x > playerOne.body.x) {
            playerTwoVictoryText.setVisible(true);
            ball.setVelocityX(0);
            ball.setVelocityY(0);
        }
        if (ball.body.x < playerTwo.body.x) {
            playerOneVictoryText.setVisible(true);
            ball.setVelocityX(0);
            ball.setVelocityY(0);
        }

        playerOne.body.setVelocityY(0);
        if (cursors.up.isDown) {
            playerOne.body.setVelocityY(-paddleSpeed);
        } else if (cursors.down.isDown) {
            playerOne.body.setVelocityY(paddleSpeed);
        }
        playerTwo.body.setVelocityY(0);
        if (keys.w.isDown) {
            playerTwo.body.setVelocityY(-paddleSpeed);
        } else if (keys.s.isDown) {
            playerTwo.body.setVelocityY(paddleSpeed);
        }
        if (ball.body.velocity.y > paddleSpeed) {
            ball.body.velocity.y = paddleSpeed;
        } else if (ball.body.velocity.y < -paddleSpeed) {
            ball.body.velocity.y = -paddleSpeed;
        }
    }
    </script>

</body>
</html>